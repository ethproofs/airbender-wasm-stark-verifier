<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WASM File Analyzer</title>
    <style>
        .section {
            margin-bottom: 20px;
        }

        .hex-list {
            font-family: monospace;
        }

        .match {
            color: green;
            font-weight: bold;
        }

        .no-match {
            color: gray;
        }
    </style>
</head>

<body>
    <h1>Fri Verifier (0.8.1)</h1>
    <p>This javascript verifies the FRI proofs <strong>locally</strong> in your browser.</p>
    <h3>Please upload program proof file</h3>
    <p>Usual file names: <strong>recursion_program_proof.json</strong> or <strong>final_program_proof.json</strong></p>
    <input type="file" id="fileInput">
    <button id="processBtn">Process</button>

    <div class="section" id="results" style="display:none;">
        <h2 style="color: green;">Success: Your proof is verified! See details below:</h2>
        <h2>Public Inputs</h2>
        <p>This is the output of your program</p>
        <div class="hex-list" id="publicInput"></div>

        <h2>Program Verification key</h2>
        <p>This is your program's verification key - a fingeprint of your program and recursions</p>
        <div class="hex-list" id="programOutput"></div>

        <h2>Known Verification keys</h2>
        <p>These are the known verification keys for zkSync OS and Airbender programs</p>
        <table border="1">
            <thead>
                <tr>
                    <th>Hash Name</th>
                    <th>Values</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="knownHashes"></tbody>
        </table>
    </div>

    <script type="module">
        import init, { wasm_verify_proof } from "./pkg/ethproofs_verifier_lib.js";

        const knownHashes = [
            {
                name: "zksync os 0.0.1 + airbender 0.0.6",
                values: [0xc530c9c7, 0xcd177820, 0x68d03325, 0xabfe99f5, 0x0a76c253, 0x7e64e015, 0x32dd94c4, 0x7189f6ba]
            },
            {
                name: "zksync-era (zksync os 0.0.2 rev0) + airbender 0.2.0",
                values: [4108140866,
                    224904200,
                    5485121,
                    2466424014,
                    3144074013,
                    1727165411,
                    2053591393,
                    2927148240]
            },
            {
                name: "zksync os 0.0.3 (evm_replay) + airbender 0.2.0",
                values: [
                    0xed87cf4f, 0x088daf6a, 0x1ba8f6bc, 0xd15b923c, 0x5a2af1fc, 0x0396cf53, 0x7268387a, 0x38330c10
                ]
            }
        ];

        function u32ArrayToHex(arr) {
            return arr.map(x => "0x" + x.toString(16).padStart(8, '0'));
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((v, i) => v === b[i]);
        }

        async function main() {
            await init();

            document.getElementById("processBtn").addEventListener("click", async () => {
                const input = document.getElementById("fileInput");
                const file = input.files[0];
                if (!file) return alert("Please choose a file first!");

                const buffer = await file.arrayBuffer();
                const bytes = new Uint8Array(buffer);

                try {

                    // Use the actual Rust function here:
                    const [verificationKey, publicInput] = wasm_verify_proof(bytes);


                    // Display public input
                    document.getElementById("publicInput").textContent = publicInput;

                    // Display program output
                    document.getElementById("programOutput").textContent = verificationKey;

                    // Compare with known hashes
                    const tbody = document.getElementById("knownHashes");
                    tbody.innerHTML = '';

                    document.getElementById("results").style.display = "block";
                } catch (err) {
                    console.error("WASM call failed:", err);
                    alert("An error occurred while processing the file:\n\n" + err.message);

                    // ðŸ”’ Hide any output
                    document.getElementById("results").style.display = "none";

                }
            });
        }

        main();
    </script>
</body>

</html>